SHELL := bash
.SHELLFLAGS := -eu -o pipefail -c # -c: Needed in .SHELLFLAGS. Default is -c.
.DEFAULT_GOAL := run

dotenv := $(PWD)/.env
-include $(dotenv)

# [Flutterã§ç’°å¢ƒã”ã¨ã«ãƒ“ãƒ«ãƒ‰è¨­å®šã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ â€” iOSç·¨. ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªé–‹ç™ºã«ãŠã„ã¦ã€ç’°å¢ƒã”ã¨ã«è¨­å®šã‚’å¤‰ãˆã¦ãƒ“ãƒ«ãƒ‰ãƒ»é…ä¿¡ã™ã‚‹ã“ã¨ã¯ã»ã¼å¿…é ˆâ€¦ | by mono ï£¿ | Flutter ðŸ‡¯ðŸ‡µ | Medium](https://medium.com/flutter-jp/flavor-b952f2d05b5d)
# ãƒ“ãƒ«ãƒ‰ãƒ¢ãƒ¼ãƒ‰
#	- debug
#		Debug: ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã‚ã‚Šã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ä½Žä¸‹
#	- release
#		Release: ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ãªã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹é«˜é€Ÿ
mode := debug
# ç’°å¢ƒè¨­å®š(ãƒã‚¤ãƒ†ã‚£ãƒ–ã¸ã®ä¼é”)
# ãƒãƒ³ãƒ‰ãƒ«IDã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã‚’å¤‰æ›´(XCodeã®Config,Androidã®productFlavorsã«ç´ã¥ã)
# 	- development
# 	- staging
# 	- production
build_flavor := development
# ç’°å¢ƒè¨­å®š(Dartã¸ã®ä¼é”)
# APIã®å‘ãå…ˆã‚’å¤‰æ›´ã™ã‚‹
dart_flavor := development
# google_service_info_plist := ./ios/Runner/Firebase/$(build_flavor)/GoogleService-Info.plist

export

clean:
	@flutter clean
dart-fix:
	@dart fix --apply
pub-get:
	@flutter pub get
pub-upgrade:
	@flutter pub upgrade
packages-upgrade:
	@flutter packages upgrade
freeze:
	@flutter pub run build_runner build --delete-conflicting-outputs

build-apk:
	# Firebaseä¸Šã§ã€developmentç”¨ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã¯ `net.algoage.dry_eye_checker`
	#     => Androidã§ Staging ã§Pushã‚’æ‰“ã¤å ´åˆã€`--flavor production` ã§ãªã„ã¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åãŒåˆã‚ãªã„ã®ã§é£›ã°ãªã„
	@make _build target=apk
build-ios:
	@make _build target=ios

_build: #_build_prepare
	@flutter build $(target) --$(mode) --flavor $(build_flavor) --dart-define=FLAVOR=$(dart_flavor)

# _build_prepare:
# 	@if [[ $(target) == "ios" ]]; then \
# 		test -e $(google_service_info_plist) && \
# 			cp -v $(google_service_info_plist) ./ios/GoogleService-Info.plist; \
# 	fi

install-apk:
	@adb install -r ./build/app/outputs/flutter-apk/app-production-debug.apk
build-install-apk: build-apk install-apk


logcat:
	@adb logcat
logcat-app:
	@app_id=$$(grep applicationId android/app/build.gradle |head -1 |cut -d\" -f2) && \
		adb logcat | grep $${app_id} --color


run: run-android
run-linux:
	@flutter run -d linux
	@make _run target=linux
run-chrome:
	@make _run target=web-javascript
run-ios:
	@make _run target=ios
run-android:
	@make _run target=android
_run: #_build_prepare
	@export device_id=$$(flutter devices --machine| jq -r '.[]|select(.targetPlatform |startswith("$(target)"))|.id') && \
		echo "==> Running on $$device_id .." && \
		flutter run -d $$device_id --$(mode) --flavor $(build_flavor) --dart-define=FLAVOR=$(dart_flavor)


devices:
	@flutter devices
