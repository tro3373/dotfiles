#!/usr/bin/env bash

readonly url_ras3=http://os.archlinuxarm.org/os/ArchLinuxARM-rpi-2-latest.tar.gz
readonly url_ras4=http://os.archlinuxarm.org/os/ArchLinuxARM-rpi-4-latest.tar.gz
readonly script_dir=$(
  cd "$(dirname ${BASH_SOURCE:-$0})"
  pwd
)
# TODO modify this device id.
device_prefix=/dev/sdX
source $script_dir/../setup/funcs

usage() {
  cat <<EOF
Create archlinux sd image command for raspberry pi 3.
EOF
}

check() {
  if is_dry; then
    return
  fi
  if ! os unix; then
    not_supported
    exit 1
  fi
  has_check fdisk
  has_check mkdfs.vfat
  has_check $mkfs_ext4
  has_check bsdtar
  root_check
}

main() {
  set -e
  local mkfs_ext4=mkfs.ext4
  is_mac && mkfs_ext4=/usr/local/opt/e2fsprogs/sbin/mkfs.ext4
  initialize_args "$@"
  check

  url=$url_ras4
  # shellcheck disable=SC2154
  if [[ ${args[*]} == ras3 ]]; then
    url=$url_ras3
  fi

  mexe fdisk ${device_prefix}
  # # At the fdisk prompt, delete old partitions and create a new one:
  # - Type o. This will clear out any partitions on the drive.
  # - Type p to list partitions. There should be no partitions left.
  # - Type n, then p for primary, 1 for the first partition on the drive, press ENTER to accept the default first sector, then type +200M for the last sector.
  # - Type t, then c to set the first partition to type W95 FAT32 (LBA).
  # - Type n, then p for primary, 2 for the second partition on the drive, and then press ENTER twice to accept the default first and last sector.
  # - Write the partition table and exit by typing w.
  mexe mkfs.vfat ${device_prefix}1
  mexe mkdir boot
  mexe mount ${device_prefix}1 boot

  mexe $mkfs_ext4 ${device_prefix}2
  mexe mkdir root
  mexe mount ${device_prefix}2 root
  mexe curl -fLO $url
  local fnm=${url##.*/}
  mexe bsdtar -xpf $fnm -C root
  mexe sync

  mexe mv root/boot/* boot
  mexe umount boot root

  show_dummy_warn_if_needed
  ink green "Done!"
}
main "$@"
