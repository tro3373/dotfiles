#!/usr/bin/env -S bash -e

readonly depends=(tgpt gemini-cli)
has() { command -v "${1}" >&/dev/null; }
hass() { for arg in "$@"; do has "$arg" || error "==> No $arg command exist."; done; }
_ink() { cat - | if has ink; then ink "$@"; else cat -; fi; }
# shellcheck disable=SC2145
_log() { echo "$(date +"%Y-%m-%d %H:%M:%S") ${@:2}" | _ink "$1"; }
log() { _log white "$*"; }
info() { _log cyan "$*"; }
warn() { _log yellow "$*"; }
error() { _log red "$*" && exit 1; }
fire() {
  if [[ -p /dev/stdin ]]; then
    cat -
  fi
  if [[ $# -ne 0 ]]; then
    echo "$@"
  fi
}

_llm() {
  # mode=gemini-cli
  mode=tgpt
  # mode=claude
  cat - |
    if [[ $mode == "tgpt" ]]; then
      # [aandrew-me/tgpt: AI Chatbots in terminal without needing API keys](https://github.com/aandrew-me/tgpt?tab=readme-ov-file)
      # Available providers to use: deepseek, gemini, groq, isou, koboldai, ollama, openai, pollinations and phind(default)
      provider=groq
      # [Supported Models - GroqDocs](https://console.groq.com/docs/models)
      model=gemma2-9b-it
      command tgpt --provider $provider --model $model --key "$GROQ_API_KEY" "$(cat -)"
    # elif [[ $mode == "claude" ]]; then
    #   command claude -p
    else
      model=gemini-2.5-flash-preview-04-17
      # model=gemini-2.5-pro-preview-05-06
      command gemini-cli prompt --model $model -
    fi
}

main() {
  hass "${depends[@]}"
  if [[ $# -eq 0 && ! -p /dev/stdin ]]; then
    error "==> No input data."
  fi
  fire "$@" | _llm
}
main "$@"
