#!/bin/bash

root_dir=${1:-~/works/50_src}
_pull() {
    local target=$1
    cd $target >/dev/null 2>&1
    echo "Updating repository($target) ... "
    local modified_list=$(git status -s)
    local modify=$(echo "$modified_list" | grep -v '??' | wc -l)
    local stash=0
    if [[ $modify -gt 0 ]]; then
        echo "==> Modified sources exist. stash saving ..."
        echo "$modified_list"
        stash=1
        git stash >/dev/null
    fi
    echo "==> Pull rebasing ..."
    git pull -q --rebase >/dev/null
    if [[ $stash -eq 1 ]]; then
        echo "==> stash poping ..."
        git stash pop >/dev/null
    fi
}
main() {
    for f in `find $root_dir -maxdepth 3 -name ".git" -type d`; do
        dir=$(basename $(dirname $f))
        dir=$(cd $root_dir/$dir && pwd)
        _pull $dir
    done
}
main $*
