#!/usr/bin/env -S bash -euo pipefail

# gh_pr_review_tasks - GitHub PR ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
command_name=$(basename "$0") && readonly command_name

usage() {
  cat <<EOF
Usage: $command_name <pr_number> [--all]
  Extract and display task files referenced in PR review comments

  Examples:
    $command_name 145
EOF
}

# TODO: commentã®URLã‚‚è¿½è¨˜ã—ãŸã„
fire_comments() {
  # ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ
  # gh api "repos/${repo}/pulls/${pr_number}/comments" --jq '.[] | {user: .user.login, body: .body}' 2>/dev/null || true
  # ã‚³ãƒ¼ãƒ‰ã«å¯¾ã™ã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿å–å¾—ï¼ˆpathãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã‚‚ã®ï¼‰
  gh api "repos/${repo}/pulls/${pr_number}/comments" --jq '.[] | select(.path != null) | {user: .user.login, body: .body, path: .path, line: .line, side: .side, diff_hunk: .diff_hunk}' 2>/dev/null || true
  # PRãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆ
  gh api "repos/${repo}/pulls/${pr_number}/reviews" --jq '.[] | select(.body != null and .body != "") | {user: .user.login, body: .body}' 2>/dev/null || true
  # ã‚¤ã‚·ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆPRå…¨ä½“ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
  gh api "repos/${repo}/issues/${pr_number}/comments" --jq '.[] | {user: .user.login, body: .body}' 2>/dev/null || true
}

main() {
  # å¼•æ•°ãƒã‚§ãƒƒã‚¯
  if [[ $# -lt 1 ]]; then
    usage
    elog "==> Error: PR number is required."
  fi

  pr_number="$1"

  # ç„¡è¦–ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é…åˆ—
  ignore_patterns=(
    '^## Pull Request Overview.*$'
    '^## Code Review.*$'
    '^## Summary of Changes.*$'
    '^/gemini.*$'
  )

  repo=$(gh repo view --json nameWithOwner -q .nameWithOwner)

  ilog "==> ğŸ“‹ Fetching PR #${pr_number} code review comments..."
  echo '- [ ] **Code Review Tasks**'
  # ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿å–å¾—
  fire_comments |
    jq -s '.' |
    jq -r '.[] | @json' |
    while IFS= read -r json_line; do
      body=$(echo "$json_line" | jq -r '.body')
      # ç„¡è¦–ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒã‚§ãƒƒã‚¯
      skip=false
      for pattern in "${ignore_patterns[@]}"; do
        if [[ $body =~ $pattern ]]; then
          skip=true
          break
        fi
      done
      [[ $skip == true ]] && continue
      [[ -z $body ]] && continue
      ## Summary of Changes
      user=$(echo "$json_line" | jq -r '.user')
      path=$(echo "$json_line" | jq -r '.path // ""')
      line=$(echo "$json_line" | jq -r '.line // ""')
      side=$(echo "$json_line" | jq -r '.side // ""')
      ref=
      [[ -n $path ]] && ref="${path}"
      [[ -n $line ]] && ref="${ref}#L${line}"
      [[ -n $side ]] && ref="${ref} (${side})"
      [[ -n $ref ]] && ref="\`${ref}\`"

      # Markdownå½¢å¼ã§ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’å‡ºåŠ›ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¨è¡Œç•ªå·ä»˜ãï¼‰
      echo "  - [ ] ğŸ“ ${ref} by ğŸ‘¤ ${user}"

      # bodyã®å„è¡Œã«4ã‚¹ãƒšãƒ¼ã‚¹ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’è¿½åŠ 
      while IFS= read -r line; do
        [[ -z $line ]] && continue
        echo "    ${line}"
      done <<<"$body"
      echo ""
    done
  ilog "âœ… Task extraction complete!"
}
main "$@"
