#!/usr/bin/env bash

readonly pidf=/tmp/clipd.pid
debug=0

has() { command -v ${1} >&/dev/null; }
is_debug() { [[ $debug -eq 1 ]]; }
initialize() {
  if [[ -e $pidf ]]; then
    is_debug && echo "=> Already clipd running."
    exit 0
  fi
  for arg in "$@"; do
    case "$arg" in
      -d) debug= ;;
    esac
  done
}

check() {
  if ! has nc; then
    echo "No nc command exist" 1>&2
    exit 1
  fi
  if ! has clip; then
    echo "No clip command exist" 1>&2
    exit 1
  fi
  check
}

clipd() {
  while (true); do
    is_debug && echo "=> Waiting clip.."
    nc -l 5556 | clip
  done
}

end() {
  [[ ! -e $pidf ]] && return
  is_debug && echo "=> End Removing $pidf.."
  rm $pidf
}

main() {
  initialize "$@"
  echo $$ >$pidf
  # 0 プロセス終了時に、プロセスが自分自身に対して送出する EXIT シグナル。
  # 1 XWindow のクローズや、デーモンのリセットに使用されるハングアップシグナル。
  # 2 Ctrl+C や Del キーを押したときに発生する割り込みシグナル。
  # 3 Ctrl+\ を押したときに発生するクイットシグナル。
  # 9 プロセスを強制終了するためのキルシグナル。強制終了なので当然、trap はできない。
  #15 プロセスを終了させるための終了シグナル。kill コマンドはデフォルトでこのシグナルを使用する (つまり kill PID は kill -15 PID と同じ結果になる)。
  trap end 0 1 2 3 15
  clipd
}
main "$@" &
