#!/usr/bin/env bash

#-------------------------------------------------------
# @ see https://blog.ojisan.io/prettier-eslint-cli
#-------------------------------------------------------

command_name=$(basename $0)
dummy="echo"
vue=0
husky=0
args=()
usage() {
  cat <<EOF

Enable eslint/prettier husky settings

  Usage:
    $command_name [option]
  Options
    -h|--help : Show this usage
    -e        : Excute (default is dry-run mode)
    -k        : With husky
    -v        : With vue pkgs

EOF
}
log() { echo "$(date +"%Y-%m-%d %H:%M:%S") $*" | ink yellow; }
add_args() { args+=("$@"); }
is_dummy() { [[ -n $dummy ]]; }
initialize() {
  while true; do
    [[ -z $1 ]] && break
    case "$1" in
      -h | --help) usage && exit 0 ;;
      -e) dummy= ;;
      -v) vue=1 ;;
      -k) husky=1 ;;
      #-f*|--file*) file=${1#*=} ;;
      #-f|--file) shift && file=$1 ;;
      *) add_args "$1" ;;
    esac
    shift
  done
}
cat_add_scripts() {
  cat <<'EOF'
  "scripts": {
    "lint-fix": "eslint --fix './**/*.{js,vue}' && prettier --write './**/*.{js,vue}'",
  },
EOF
}
cat_husky_settings() {
  cat <<'EOF'
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged"
    }
  },
  "lint-staged": {
    "*.{js,jsx,vue}": [
      "npm run lint-fix",
      "git add"
    ]
  }
EOF
}

cat_vscode_extensions_recommendations() {
  cat <<'EOF'
{
  "recommendations": [
    "esbenp.prettier-vscode",
    "dbaeumer.vscode-eslint"
  ]
}
EOF
}
setup_vscode_extensions_recommendations() {
  local target_d="$(get_git_root)/.vscode"
  local target_f=$target_d/extensions.json
  if [[ -e $target_f ]]; then
    log "==> $target_f is exist. check below contents is already exist."
    return
  fi
  cat_vscode_extensions_recommendations |
    if is_dummy; then
      log "==> Bellow content will be added to $target_f..."
      cat -
    else
      $dummy mkdir -p
      cat - >$target_f
    fi
}
main() {
  initialize "$@"

  local pkgs=(eslint eslint-config-prettier prettier)
  # pkgs+=("yarn prettier-eslint-cli prettier-eslint")
  if [[ $husky -eq 1 ]]; then
    pkgs+=("husky" "lint-staged")
  fi
  if [[ $vue -eq 1 ]]; then
    pkgs+=("eslint-plugin-vue" "babel-eslint")
  fi
  log "==> Installing packages.."
  $dummy npm i -D "${pkgs[@]}"
  log "==> Bellow settings is needed to package.json."
  cat_add_scripts
  if [[ $husky -eq 1 ]]; then
    log "==> Bellow husky settings also is needed."
    cat_husky_settings
  fi
  setup_vscode_extensions_recommendations
}
main "$@"
