#!/bin/bash

target=$1
_exe() {
    cmd=$*
    rc=1
    result=
    result=$($cmd 2>&1) && rc=0
    if [[ $rc -ne 0 ]]; then
        echo "!!Abort!! while updating $target cmd: $cmd"
        echo "      ==> $result"
        exit 1
    fi
}
main() {
    if [[ ! -z $target ]]; then
        cd $target
    fi
    local modified=$(git status -s)
    local stash=0
    local stash_msg=""
    if [[ "$modified" != "" ]]; then
        local shuld_stash=$(echo "$modified" | grep -v '??' | wc -l)
        if [[ $shuld_stash -gt 0 ]]; then
            stash=1
            stash_msg="(with_stash)"
            _exe git stash -q
        fi
    fi
    _exe git pull --rebase
    local nochanged=$(echo "$result" | grep "up to date" | wc -l)
    local update_msg="up-to-date"
    if [[ $nochanged -eq 0 ]]; then
        update_msg="pulled"
    fi
    if [[ $stash -eq 1 ]]; then
        _exe git stash pop -q
    fi
    echo "==> Success to update ($update_msg) $stash_msg $target"
    if [[ "$modified" != "" ]]; then
        echo "$modified"
    fi
    if [[ ! -z $target ]]; then
        cd - >/dev/null 2>&1
    fi
}
main $*
